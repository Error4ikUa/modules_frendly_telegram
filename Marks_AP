import random
import asyncio
import logging
from .. import loader, utils

logger = logging.getLogger(__name__)

class MarksMod(loader.Module):
    """Модуль для отримання оцінок 105 групи"""

    strings = {
        "name": "Marks",
        "loading": [
            "Отримую ніщі оцінки",
            "Боже, да там немає на що дивитися",
            "ХАХАХКХ, одні двойки",
            "Тільки в одного великого журналіста все чотко",
            "Шо цікаво? Ну ладно, дивіться дивіться",
        ],
        "final_texts": [
            "Ну і фігня",
            "Ну і говно",
            "Шо, опять викладач нічого не виставив",
            "Мда, ну і двоїшники",
        ],
        "welcome": (
            "Привіт! Модуль створений онлі для 105 групи для оцінок з АП.\n"
            "<b>.marks</b> - показує оцінки групи."
        ),
    }

    async def client_ready(self, client, db):
        self.client = client
        self.db = db
        logger.info("Marks модуль готовий до роботи")

    async def marks_cmd(self, message):
        """Отримати оцінки групи"""
        bot_username = "@siteshot_bot"
        link = "https://docs.google.com/spreadsheets/u/0/d/10H_Opy_0Dg4coYwTwsvEOd6ysLAqyLeIi8tamOOLsfU/htmlview"
        
        # Надсилання повідомлення про дію
        sent_info_msg = await message.respond(f"Написав {bot_username}")

        # Надсилання посилання боту
        bot = await self.client.get_entity(bot_username)
        await self.client.send_message(bot, link)

        # Анімація тексту
        loading_msgs = []
        for text in self.strings["loading"]:
            msg = await message.edit(text)
            loading_msgs.append(msg)
            await asyncio.sleep(1)

        # Очікування відповіді від бота
        await asyncio.sleep(5)

        # Отримання останнього повідомлення від бота
        async for msg in self.client.iter_messages(bot, limit=1):
            if msg.photo:
                random_text = random.choice(self.strings["final_texts"])
                await self.client.send_file(message.peer_id, msg.photo, caption=random_text)
                
                # Видалення двох попередніх повідомлень
                for msg_to_delete in loading_msgs + [sent_info_msg]:
                    await msg_to_delete.delete()
                return

        # Якщо щось пішло не так
        await message.respond("<b>Щось пішло не так. Перевірте, чи бот працює.</b>")
