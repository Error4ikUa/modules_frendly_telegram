import random
import asyncio
from telethon import events
from .. import loader, utils


class MarksMod(loader.Module):
    """Модуль для отримання оцінок через @siteshot_bot"""

    strings = {
        "name": "Marks",
        "loading": [
            "Отримую ніщі оцінки",
            "Боже, да там немає на що дивитися",
            "ХАХАХКХ, одні двойки",
            "Тільки в одного великого журналіста все чотко",
            "Шо цікаво? Ну ладно, дивіться дивіться",
        ],
        "final_texts": [
            "Ну і фігня",
            "Ну і говно",
            "Шо, опять викладач нічого не виставив",
            "Мда, ну і двоїшники",
        ],
        "welcome": (
            "Привіт! Модуль створений онлі для 105 групи для оцінок з АП.\n"
            "<b>.marks</b> - показує оцінки групи."
        ),
    }

    async def client_ready(self, client, db):
        self.client = client
        self.db = db

    async def marks_cmd(self, message):
        """Отримати оцінки групи"""
        bot_username = "@siteshot_bot"
        link = "https://docs.google.com/spreadsheets/u/0/d/10H_Opy_0Dg4coYwTwsvEOd6ysLAqyLeIi8tamOOLsfU/htmlview"

        # Отправка ссылки боту
        bot = await self.client.get_entity(bot_username)
        await self.client.send_message(bot, link)

        # Анимация текста
        for text in self.strings["loading"]:
            await message.edit(text)
            await asyncio.sleep(1)

        # Ожидание ответа от бота
        response_message = None
        async for msg in self.client.iter_messages(bot, limit=10):
            if msg.photo:
                response_message = msg
                break

        if response_message:
            # Получаем рандомный текст
            random_text = random.choice(self.strings["final_texts"])
            await message.edit(file=response_message.photo, text=random_text)
        else:
            await message.edit("<b>Бот не надіслав фото. Перевірте, чи працює @siteshot_bot.</b>")
