from .. import loader, utils
import asyncio

class SpizdMod(loader.Module):
    strings = {
        "name": "Spizd",
        "description": "üì• –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤—ñ–¥–µ–æ, —Ñ–æ—Ç–æ —Ç–∞ –∞—É–¥—ñ–æ –∑ TikTok, Instagram, Pinterest.",
        "usage": ".spizd <–ø–æ—Å–∏–ª–∞–Ω–Ω—è> ‚Äî –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î –º–µ–¥—ñ–∞ –∑ –≤–∫–∞–∑–∞–Ω–æ–≥–æ –¥–∂–µ—Ä–µ–ª–∞."
    }

    async def client_ready(self, client, db):
        self.client = client

    async def spizdcmd(self, message):
        args = utils.get_args_raw(message)
        if not args:
            await message.edit("‚ùå –í–∫–∞–∂—ñ—Ç—å –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –∫–æ–Ω—Ç–µ–Ω—Ç.")
            return

        bot_entity = "@SaveAsBot"
        await message.edit("‚è≥ –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –≥–∞–ª–µ—Ä–µ—ó... üì§")
        await asyncio.sleep(2)
        await message.edit("üîû –õ—è, –∑–±–æ—á–µ–Ω–µ—Ü—å! –¢–æ–±—ñ —â–æ, –≥–∞–ª–µ—Ä–µ—ó –º–∞–ª–æ? üòÇ")
        await asyncio.sleep(2)
        await message.edit("ü§∑‚Äç‚ôÇÔ∏è –ï—Ö, –Ω—É –ª–∞–¥–Ω–æ... –¢—Ä–∏–º–∞–π —Å–≤–æ—ó —Ñ–∞–π–ª–∏ üòè")

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å—Å—ã–ª–∫—É –±–æ—Ç—É
        try:
            sent_message = await self.client.send_message(bot_entity, args)
        except Exception as e:
            await message.edit(f"‚ö†Ô∏è –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤—ñ–¥–ø—Ä–∞–≤—Ü—ñ –∑–∞–ø–∏—Ç—É: {e}")
            return

        # –ó–∞–ø–æ–º–∏–Ω–∞–µ–º ID –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
        last_message_id = sent_message.id

        # –ñ–¥—ë–º –Ω–æ–≤—ã–µ –º–µ–¥–∏–∞ –æ—Ç –±–æ—Ç–∞
        await asyncio.sleep(10)  # –û–∂–∏–¥–∞–µ–º –¥–æ 10 —Å–µ–∫—É–Ω–¥
        sent_media = []
        async for response in self.client.iter_messages(bot_entity, min_id=last_message_id):
            if response.video or response.photo or response.document or response.audio:
                sent_media.append(response)

        # –ü–µ—Ä–µ—Å—ã–ª–∞–µ–º –º–µ–¥–∏–∞—Ñ–∞–π–ª—ã –≤ —á–∞—Ç, –≥–¥–µ –±—ã–ª–∞ –≤—ã–∑–≤–∞–Ω–∞ –∫–æ–º–∞–Ω–¥–∞
        if sent_media:
            for media in sent_media:
                try:
                    await self.client.send_file(message.chat_id, media, reply_to=message.id)
                except Exception as e:
                    await message.respond(f"‚ö†Ô∏è –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ—Å–∏–ª–∞–Ω–Ω—ñ: {e}")
            await message.delete()
        else:
            await message.edit("‚ö†Ô∏è –ù–µ –≤–¥–∞–ª–æ—Å—è –∑–Ω–∞–π—Ç–∏ –º–µ–¥—ñ–∞ –∑–∞ —Ü–∏–º –ø–æ—Å–∏–ª–∞–Ω–Ω—è–º. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑!")
